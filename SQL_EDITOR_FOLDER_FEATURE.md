# âœ… SQL Editor è³‡æ–™å¤¾å»ºç«‹åŠŸèƒ½å¯¦æ–½å®Œæˆ

## ğŸ“… å®Œæˆæ—¥æœŸ
2024-01-15

## ğŸ‰ å¯¦æ–½ç‹€æ…‹

**SQL Editor è³‡æ–™å¤¾å»ºç«‹åŠŸèƒ½å·²æˆåŠŸå¯¦æ–½ä¸¦é€šéé©—è­‰ï¼**

---

## ğŸ“Š åŠŸèƒ½æ¦‚è¿°

æ–°å¢äº†æ­¥é©Ÿ 58ï¼šã€ŒSupabase SQL Editor - PRIVATE è³‡æ–™å¤¾å»ºç«‹ã€ï¼Œå¯ä»¥ï¼š
- âœ… åœ¨ PRIVATE bucket ä¸‹å»ºç«‹æ–°è³‡æ–™å¤¾
- âœ… ä½¿ç”¨è¼¸å…¥æ¬„ä½å¡«å¯«è³‡æ–™å¤¾åç¨±
- âœ… è‡ªå‹•ç”Ÿæˆå®Œæ•´çš„ SQL è…³æœ¬
- âœ… åŒ…å« RLS æ”¿ç­–ã€ç´¢å¼•ã€è¨»è§£
- âœ… å¯ç›´æ¥è¤‡è£½åˆ° Cursor åŸ·è¡Œ

---

## ğŸ¯ åŠŸèƒ½ç‰¹é»

### 1. è¼¸å…¥æ¬„ä½
- **æ¬„ä½åç¨±**ï¼šè³‡æ–™å¤¾åç¨±ï¼ˆfolder_nameï¼‰
- **æ¨™ç±¤**ï¼šè³‡æ–™å¤¾åç¨±
- **æç¤ºæ–‡å­—**ï¼šä¾‹å¦‚ï¼šdocuments, uploads, user-files
- **èªªæ˜**ï¼šè¼¸å…¥è¦åœ¨ PRIVATE bucket ä¸‹å»ºç«‹çš„è³‡æ–™å¤¾åç¨±ï¼ˆåªèƒ½åŒ…å«å°å¯«å­—æ¯ã€æ•¸å­—ã€é€£å­—è™Ÿå’Œåº•ç·šï¼‰

### 2. è‡ªå‹•ç”Ÿæˆçš„ SQL å…§å®¹

#### åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š
1. **ç¢ºèª PRIVATE bucket å­˜åœ¨**
   - å¦‚æœä¸å­˜åœ¨å‰‡è‡ªå‹•å»ºç«‹
   - è¨­å®šç‚ºç§æœ‰ï¼ˆpublic = falseï¼‰
   - è¨­å®šæª”æ¡ˆå¤§å°é™åˆ¶ï¼ˆ50MBï¼‰

2. **å»ºç«‹è³‡æ–™å¤¾çµæ§‹**
   - é€éå»ºç«‹ `.keep` æª”æ¡ˆä¾†å»ºç«‹è³‡æ–™å¤¾
   - é€™æ˜¯ Supabase Storage çš„æ¨™æº–åšæ³•

3. **è¨­å®š RLS æ”¿ç­–**
   - å…è¨±ç”¨æˆ¶ä¸Šå‚³åˆ°è‡ªå·±çš„è³‡æ–™å¤¾
   - å…è¨±ç”¨æˆ¶è®€å–è‡ªå·±è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ
   - å…è¨±ç”¨æˆ¶æ›´æ–°è‡ªå·±è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ
   - å…è¨±ç”¨æˆ¶åˆªé™¤è‡ªå·±è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ
   - ç®¡ç†å“¡å¯ä»¥è®€å–æ‰€æœ‰æª”æ¡ˆ

4. **å»ºç«‹ç´¢å¼•**
   - æå‡æŸ¥è©¢æ•ˆèƒ½
   - é‡å°è©²è³‡æ–™å¤¾çš„æŸ¥è©¢å„ªåŒ–

5. **å»ºç«‹è¨»è§£**
   - èªªæ˜æ¯å€‹æ”¿ç­–çš„ç”¨é€”
   - èªªæ˜è³‡æ–™å¤¾çµæ§‹

6. **é©—è­‰æŸ¥è©¢**
   - å¯é¸çš„é©—è­‰ SQL
   - ç¢ºèªè³‡æ–™å¤¾å·²å»ºç«‹

---

## ğŸ“ ä½¿ç”¨æµç¨‹

### æ­¥é©Ÿ 1ï¼šé–‹å•Ÿæ­¥é©Ÿ 58
1. åœ¨ç³»çµ±ä¸­æ‰¾åˆ°ã€ŒSupabase SQL Editor - PRIVATE è³‡æ–™å¤¾å»ºç«‹ã€
2. é»æ“Šé€²å…¥æ­¥é©Ÿè©³æƒ…

### æ­¥é©Ÿ 2ï¼šå¡«å¯«è³‡æ–™å¤¾åç¨±
1. åœ¨ã€Œå¡«å¯«æ¬„ä½ã€å€å¡Šä¸­
2. è¼¸å…¥è³‡æ–™å¤¾åç¨±ï¼ˆä¾‹å¦‚ï¼š`documents`ï¼‰
3. ç³»çµ±æœƒè‡ªå‹•å°‡åç¨±å¡«å…¥ SQL ä¸­

### æ­¥é©Ÿ 3ï¼šè¤‡è£½ SQL
1. åˆ‡æ›åˆ°ã€Œä¿®æ­£æ–¹æ¡ˆã€æ¨¡å¼
2. é»æ“Šã€Œè¤‡è£½ã€æŒ‰éˆ•
3. SQL ä¸­çš„ `{{folder_name}}` æœƒè‡ªå‹•æ›¿æ›ç‚ºæ‚¨å¡«å¯«çš„åç¨±

### æ­¥é©Ÿ 4ï¼šè²¼åˆ° Cursor
1. é–‹å•Ÿ Cursor
2. è²¼ä¸Šè¤‡è£½çš„ SQL
3. Cursor æœƒè‡ªå‹•åŸ·è¡Œä¸¦å»ºç«‹è³‡æ–™å¤¾

### æ­¥é©Ÿ 5ï¼šåœ¨ Supabase åŸ·è¡Œ
1. å‰å¾€ Supabase Dashboard > SQL Editor
2. è²¼ä¸Š SQL
3. é»æ“ŠåŸ·è¡Œï¼ˆRunï¼‰
4. ç¢ºèªåŸ·è¡ŒæˆåŠŸ

### æ­¥é©Ÿ 6ï¼šé©—è­‰
1. åˆ‡æ›åˆ°ã€Œé©—è­‰æ­¥é©Ÿã€æ¨¡å¼
2. åŸ·è¡Œé©—è­‰ SQL
3. ç¢ºèªè³‡æ–™å¤¾å·²å»ºç«‹

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### è³‡æ–™å¤¾çµæ§‹
```
private/
  â””â”€â”€ {{folder_name}}/
      â””â”€â”€ {user_id}/
          â””â”€â”€ filename
```

### RLS æ”¿ç­–èªªæ˜

#### 1. ä¸Šå‚³æ”¿ç­–
```sql
CREATE POLICY "Users can upload to {{folder_name}} folder"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'private' AND
  name LIKE '{{folder_name}}/%' AND
  (storage.foldername(name))[2] = auth.uid()::text
);
```
- åªå…è¨±å·²ç™»å…¥ç”¨æˆ¶
- åªèƒ½ä¸Šå‚³åˆ°è‡ªå·±çš„è³‡æ–™å¤¾ï¼ˆ`{{folder_name}}/{user_id}/`ï¼‰

#### 2. è®€å–æ”¿ç­–
```sql
CREATE POLICY "Users can read from {{folder_name}} folder"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'private' AND
  name LIKE '{{folder_name}}/%' AND
  (
    (storage.foldername(name))[2] = auth.uid()::text
    OR
    EXISTS (
      SELECT 1 FROM members
      WHERE user_id = auth.uid() AND role = 'admin'
    )
  )
);
```
- ç”¨æˆ¶å¯ä»¥è®€å–è‡ªå·±è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ
- ç®¡ç†å“¡å¯ä»¥è®€å–æ‰€æœ‰æª”æ¡ˆ

#### 3. æ›´æ–°æ”¿ç­–
```sql
CREATE POLICY "Users can update {{folder_name}} folder files"
ON storage.objects FOR UPDATE
TO authenticated
USING (
  bucket_id = 'private' AND
  name LIKE '{{folder_name}}/%' AND
  (storage.foldername(name))[2] = auth.uid()::text
);
```
- åªå…è¨±æ›´æ–°è‡ªå·±è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ

#### 4. åˆªé™¤æ”¿ç­–
```sql
CREATE POLICY "Users can delete from {{folder_name}} folder"
ON storage.objects FOR DELETE
TO authenticated
USING (
  bucket_id = 'private' AND
  name LIKE '{{folder_name}}/%' AND
  (storage.foldername(name))[2] = auth.uid()::text
);
```
- åªå…è¨±åˆªé™¤è‡ªå·±è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ

---

## ğŸ“‹ ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1ï¼šå»ºç«‹ documents è³‡æ–™å¤¾

1. **å¡«å¯«æ¬„ä½**ï¼š
   - è³‡æ–™å¤¾åç¨±ï¼š`documents`

2. **ç”Ÿæˆçš„ SQL**ï¼š
   ```sql
   -- å»ºç«‹è³‡æ–™å¤¾çµæ§‹
   INSERT INTO storage.objects (bucket_id, name, owner, metadata)
   VALUES (
     'private',
     'documents/.keep',
     auth.uid(),
     '{"folder": true, "created_by": "sql_editor"}'::jsonb
   );
   
   -- RLS æ”¿ç­–æœƒè‡ªå‹•ä½¿ç”¨ 'documents' ä½œç‚ºè³‡æ–™å¤¾åç¨±
   ```

3. **è³‡æ–™å¤¾çµæ§‹**ï¼š
   ```
   private/
     â””â”€â”€ documents/
         â””â”€â”€ {user_id}/
             â””â”€â”€ filename
   ```

### ç¯„ä¾‹ 2ï¼šå»ºç«‹ user-uploads è³‡æ–™å¤¾

1. **å¡«å¯«æ¬„ä½**ï¼š
   - è³‡æ–™å¤¾åç¨±ï¼š`user-uploads`

2. **ç”Ÿæˆçš„ SQL**ï¼š
   - æ‰€æœ‰ SQL ä¸­çš„ `{{folder_name}}` æœƒè‡ªå‹•æ›¿æ›ç‚º `user-uploads`

3. **è³‡æ–™å¤¾çµæ§‹**ï¼š
   ```
   private/
     â””â”€â”€ user-uploads/
         â””â”€â”€ {user_id}/
             â””â”€â”€ filename
   ```

---

## âœ… é©—è­‰çµæœ

- âœ… å»ºç½®æˆåŠŸï¼ˆ`npm run build`ï¼‰
- âœ… TypeScript é¡å‹æª¢æŸ¥é€šé
- âœ… è¼¸å…¥æ¬„ä½æ­£ç¢ºé¡¯ç¤º
- âœ… è®Šæ•¸æ›¿æ›åŠŸèƒ½æ­£å¸¸
- âœ… SQL èªæ³•æ­£ç¢º
- âœ… RLS æ”¿ç­–å®Œæ•´
- âœ… å·¥ä½œæµç¨‹éˆå·²è¨­å®š

---

## ğŸ¯ åŠŸèƒ½äº®é»

### 1. è‡ªå‹•åŒ–ç¨‹åº¦é«˜
- åªéœ€å¡«å¯«è³‡æ–™å¤¾åç¨±
- è‡ªå‹•ç”Ÿæˆå®Œæ•´ SQL
- åŒ…å«æ‰€æœ‰å¿…è¦çš„è¨­å®š

### 2. å®‰å…¨æ€§
- å®Œæ•´çš„ RLS æ”¿ç­–
- ç”¨æˆ¶åªèƒ½å­˜å–è‡ªå·±çš„è³‡æ–™å¤¾
- ç®¡ç†å“¡æœ‰ç‰¹æ®Šæ¬Šé™

### 3. æ˜“ç”¨æ€§
- æ¸…æ™°çš„è¼¸å…¥æ¬„ä½
- è©³ç´°çš„èªªæ˜æ–‡å­—
- å¯ç›´æ¥è¤‡è£½ä½¿ç”¨

### 4. å®Œæ•´æ€§
- åŒ…å«è¨ºæ–·ã€ä¿®æ­£ã€é©—è­‰ä¸‰å€‹æ¨¡å¼
- æä¾›é©—è­‰ SQL
- åŒ…å«ä½¿ç”¨èªªæ˜

---

## ğŸ“ æ³¨æ„äº‹é …

### è³‡æ–™å¤¾å‘½åè¦å‰‡
- åªèƒ½åŒ…å«å°å¯«å­—æ¯ã€æ•¸å­—ã€é€£å­—è™Ÿï¼ˆ-ï¼‰å’Œåº•ç·šï¼ˆ_ï¼‰
- å»ºè­°ä½¿ç”¨å°å¯«å­—æ¯å’Œé€£å­—è™Ÿï¼ˆä¾‹å¦‚ï¼š`user-files`ï¼‰
- é¿å…ä½¿ç”¨ç‰¹æ®Šå­—å…ƒæˆ–ç©ºæ ¼

### PRIVATE bucket
- å¿…é ˆå…ˆç¢ºèª PRIVATE bucket å­˜åœ¨
- å¦‚æœä¸å­˜åœ¨ï¼ŒSQL æœƒè‡ªå‹•å»ºç«‹
- PRIVATE bucket é è¨­ç‚ºç§æœ‰ï¼ˆpublic = falseï¼‰

### æ¬Šé™è¨­å®š
- æ‰€æœ‰æ”¿ç­–éƒ½åŸºæ–¼ç”¨æˆ¶ IDï¼ˆauth.uid()ï¼‰
- è³‡æ–™å¤¾çµæ§‹ï¼š`{{folder_name}}/{user_id}/filename`
- ç®¡ç†å“¡å¯ä»¥è®€å–æ‰€æœ‰æª”æ¡ˆï¼ˆå¦‚æœ members è¡¨å­˜åœ¨ï¼‰

---

## ğŸ”— ç›¸é—œæ­¥é©Ÿ

- **æ­¥é©Ÿ 2**ï¼šSupabase Storage åœ–ç‰‡ä¸²æ¥
- **æ­¥é©Ÿ 25**ï¼šè³‡æ–™åº«é·ç§»ç®¡ç†

---

## ğŸ‰ ç¸½çµ

SQL Editor è³‡æ–™å¤¾å»ºç«‹åŠŸèƒ½å·²æˆåŠŸå¯¦æ–½ï¼Œæä¾›äº†ï¼š
- âœ… ç°¡å–®æ˜“ç”¨çš„è¼¸å…¥ä»‹é¢
- âœ… è‡ªå‹•ç”Ÿæˆçš„å®Œæ•´ SQL
- âœ… å®Œæ•´çš„ RLS æ”¿ç­–
- âœ… å¯ç›´æ¥è¤‡è£½åˆ° Cursor ä½¿ç”¨
- âœ… å®Œæ•´çš„é©—è­‰æµç¨‹

**åŠŸèƒ½å·²é€šéé©—è­‰ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼** ğŸš€
